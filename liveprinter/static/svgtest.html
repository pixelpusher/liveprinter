<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/svg.js/2.6.6/svg.min.js" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"
            integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
            crossorigin="anonymous"></script>
    <script src="svgpath.js"></script>
    <style type="text/css">
        #drawing {
            width: 90%;
            min-height: 400px;
            border: 1px dotted black;
        }
    </style>

</head>
<body>
    <div id="filelocation"><input name="url" value="whitebolt2.svg"/><input type="button" id="render" value="render" /></div>
    <div id="error">...</div>
    <div><input type="button" id="redo" value="redo" /><input name="scale" value="0.5" /></div>
    <div id="drawing"></div>

    <script type="text/javascript">
        "use strict";

        $("#render").click(function () {
            doEverything($("input[name=url]").val());
        });
        $("#redo").click(function () {

            let scaling = parseFloat($("input[name=scale]").val());

            let testt = paths2code(globals.paths, (x, y) => [x * scaling, y * scaling]);
            $("#code").val(testt);
            console.log(testt);
        });

        var globals = this; 
        var scale = 0.20; // scale all points down
        var xoff = 61.6;
        var yoff = 55.4;
        var minx = 99999;
        var maxx = -99999;
        var miny = 99999;
        var maxy = -99999;

        function doEverything(filename) {
            if (filename === undefined) filename = "whitebolt2.svg";

            $("#drawing").empty();
            $("#code").val('');
            $("#vars").val('');

            globals.mysvg = SVG("drawing")
            globals.paths = [];

            const jqxhr = $.ajax({ url: filename, dataType: "text" })
                .done(function (content) {

                    globals.mysvg.svg(content);

                    // SVG loaded
                    console.log(globals.mysvg);

                    //globals.SVGOutline = initSVG(content);
                    const svgElem = $("#drawing svg");

                    svgElem.find("g").each(function () {
                        $(this).children("path").each(function () {
                            const d = this.getAttribute("d");
                            globals.paths.push(parseSVGPath(d, xoff, yoff));
                        });
                    });

                    let pathsText = '[';

                    globals.paths.map(path => {
                        if (path && path.length) {
                            let pp = path[0];
                            let prevText = $("#code").val();
                            let cmd = `lp.move({"x":${(parseFloat(pp[0]) * scale).toFixed(4)}, "y":${(parseFloat(pp[1]) * scale).toFixed(4)}});\n`;
                            $("#code").val(prevText + cmd);

                            pathsText += '[';

                            path.map(points => {
                                points.map(p => {
                                    let x = parseFloat(p[0]) * scale;
                                    let y = parseFloat(p[1]) * scale;

                                    maxx = Math.max(x, maxx);
                                    minx = Math.min(x, minx);
                                    maxy = Math.max(y, maxy);
                                    miny = Math.min(y, miny);

                                    prevText = $("#code").val();
                                    cmd = `lp.extrude({"x":${x.toFixed(4)}, "y":${y.toFixed(4)}});\n`;
                                    $("#code").val(prevText + cmd);

                                    pathsText += `[${x}, ${y}],`
                                });
                            });
                            if (pathsText[pathsText.length - 1] === ',') pathsText = pathsText.substr(0, pathsText.length - 1);
                            pathsText = pathsText + '],';
                        }
                    });
                    if (pathsText[pathsText.length - 1] === ',') pathsText = pathsText.substr(0, pathsText.length - 1);
                    pathsText = pathsText + ']';


                    let bounds = [minx, maxx, miny, maxy];

                    let prevText = $("#vars").val();

                    prevText += `\nlet bounds = [${bounds.toString()}];\n`;
                    prevText += `\nlet paths = ${pathsText};\n`;
                    $("#vars").val(prevText);


                    console.log(bounds);

                })
                .fail(function () {
                    $("#error").html("file load error:" + filename);
                });
        }

        $.when($.ready).then(function (global) {
            doEverything("whitebolt2.svg");
        });

    </script>
    <div id="output">
        <textarea id="vars" cols="160" rows="10"></textarea>
        <textarea id="code" cols="160" rows="40"></textarea>
    </div>
</body>
</html>